<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Aggressive cache control for HTML -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <base href="/">
    <title>ProposalKit — Professional Proposals in Minutes</title>
    <meta name="description" content="Create professional proposals with 13 PDF templates. Track payments, manage clients, and close deals faster. Free forever.">
    <meta property="og:title" content="ProposalKit — Professional Proposals">
    <meta property="og:description" content="Create stunning proposals, invoices, and contracts. 13 PDF templates. Payment tracking. Client management.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://proposalkit.vercel.app/">
    <meta property="og:image" content="https://proposalkit.vercel.app/assets/icons/og-image.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ProposalKit — Professional Proposals">
    <meta name="twitter:description" content="Create professional proposals with 13 PDF templates. Free forever.">
    <meta name="twitter:image" content="https://proposalkit.vercel.app/assets/icons/og-image.png">
    <meta name="theme-color" content="#ffffff">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://api.anthropic.com https://plausible.io https://accounts.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com; font-src https://fonts.gstatic.com; img-src 'self' data: blob: https://*.googleusercontent.com; connect-src 'self' https://*.supabase.co https://api.anthropic.com https://plausible.io https://accounts.google.com https://*.googleapis.com https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://assets-v2.lottiefiles.com https://lottie.host; frame-src https://accounts.google.com https://*.supabase.co; frame-ancestors 'self';">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.svg">
    <!-- Preconnect to CDN origins (reduce DNS/TLS latency) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://plausible.io">
    <!-- Analytics (Plausible — no cookies, GDPR compliant) -->
    <script defer data-domain="proposalkit.vercel.app" src="https://plausible.io/js/script.js"></script>
    <!-- JetBrains Mono for code (SF Pro / Helvetica Neue are system fonts) -->
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <!-- Lottie Player (for empty state animation) -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@lottiefiles/dotlottie-wc@0.8.16/+esm"></script>
    <!-- Lucide Icons (vendored locally) -->
    <script src="assets/js/vendor/lucide-0.460.0.js?v=18"></script>
    <!-- DOMPurify for XSS protection -->
    <script src="assets/js/vendor/dompurify.min.js?v=18"></script>
    <!-- Tailwind CSS v4 Browser CDN (pinned, SRI not practical for dynamic compilation) -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4.0.0"></script>
    <!-- Supabase JS Client (vendored locally) -->
    <script src="assets/js/vendor/supabase-2.49.1.js?v=18"></script>
    <!-- Razorpay Checkout -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- Light mode only — no theme detection needed -->
    <!-- App CSS (modular) -->
    <link rel="stylesheet" href="assets/css/variables.css?v=18">
    <link rel="stylesheet" href="assets/css/components.css?v=18">
    <link rel="stylesheet" href="assets/css/layout.css?v=18">
    <link rel="stylesheet" href="assets/css/pages.css?v=18">
    <link rel="stylesheet" href="assets/css/features.css?v=18">
    <link rel="stylesheet" href="assets/css/pdf.css?v=18">
    <link rel="stylesheet" href="assets/css/responsive.css?v=18">
    <link rel="stylesheet" href="assets/css/print.css?v=18">

</head>

<body>

    <!-- ═══ NOSCRIPT / OFFLINE FALLBACK ═══ -->
    <noscript>
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:32px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#fafafa">
            <div style="max-width:420px;text-align:center;background:#fff;padding:48px 32px;border-radius:16px;border:1px solid #e4e4e7">
                <div style="font-size:48px;margin-bottom:16px">&#128274;</div>
                <div style="font-size:20px;font-weight:700;color:#18181b;margin-bottom:8px">JavaScript Required</div>
                <div style="font-size:14px;color:#71717a;line-height:1.6">ProposalKit needs JavaScript to run. Please enable it in your browser settings and reload.</div>
                <a href="/" style="display:inline-block;margin-top:24px;padding:10px 24px;background:#18181b;color:#fff;border-radius:9999px;text-decoration:none;font-size:14px;font-weight:500">Reload</a>
            </div>
        </div>
    </noscript>

    <!-- ═══ LOADING SCREEN ═══ -->
    <div id="bootLoader" style="position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:99999;transition:opacity 0.3s">
        <div style="text-align:center">
            <div style="width:48px;height:48px;margin:0 auto 16px;border:3px solid #18181b;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div>
            <div style="font-size:14px;font-weight:600;color:#18181b">Loading ProposalKit...</div>
            <div style="font-size:12px;color:#71717a;margin-top:4px">This should only take a moment</div>
        </div>
    </div>

    <!-- ═══ AUTH + ONBOARDING ═══ -->
    <div class="onboard" id="onboard">
        <!-- Auth: shadcn two-column split -->
        <div class="auth-split" id="authSplit" style="display:none">
            <div class="auth-left">
                <div class="auth-left-top">
                    <div class="auth-brand-icon">P</div>
                    <span class="auth-brand-name">ProposalKit</span>
                </div>
                <div class="auth-left-bottom">
                    <blockquote class="auth-quote">&ldquo;ProposalKit has completely transformed how I send proposals. What used to take hours now takes minutes.&rdquo;</blockquote>
                    <div class="auth-quote-author">Sofia Davis</div>
                </div>
            </div>
            <div class="auth-right">
                <div class="auth-right-top" id="authRightTop"></div>
                <div id="authContent"></div>
            </div>
        </div>
        <!-- Onboarding: card style -->
        <div class="ob-card ob-card-wide" id="obCard">
            <div class="ob-icon">P</div>
            <div id="obContent"></div>
        </div>
    </div>

    <!-- ═══ APP ═══ -->
    <a href="#bodyScroll" class="skip-link">Skip to main content</a>
    <div class="app" id="appShell" style="display:none">
        <!-- Mobile sidebar overlay -->
        <div class="side-overlay" id="sideOverlay" onclick="closeMobileSidebar()"></div>

        <!-- Sidebar — shadcn/ui sidebar-07 -->
        <aside class="side" id="sidebar" role="navigation" aria-label="Main navigation">
            <div class="side-rail" onclick="toggleSidebar()"></div>
            <!-- SidebarHeader -->
            <div class="side-header">
                <button class="side-team-btn" onclick="toggleSidebar()">
                    <div class="side-team-logo" id="sideLogo">P</div>
                    <span class="side-team-name" id="sideBrand">ProposalKit</span>
                </button>
            </div>
            <!-- SidebarContent -->
            <div class="side-body">
                <!-- NavMain group -->
                <div class="side-group">
                    <div class="side-new-wrap">
                        <button class="side-new-full" onclick="openNewModal()" data-tooltip="New Proposal (⌘N)" data-side="bottom">
                            <i data-lucide="circle-plus"></i><span>Quick Create</span>
                        </button>
                        <button class="side-new-icon" onclick="openCommandPalette()" data-tooltip="Search (⌘K)" data-side="bottom">
                            <i data-lucide="search"></i>
                        </button>
                    </div>
                    <div class="side-nav">
                        <button class="side-btn on" data-nav="dashboard" onclick="navigate('/dashboard')"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></button>
                        <button class="side-btn" data-nav="editor" onclick="navigate('/proposals')"><i data-lucide="file-text"></i><span>Proposals</span><span class="cnt" id="propCnt">0</span></button>
                        <button class="side-btn" data-nav="clients" onclick="navigate('/clients')"><i data-lucide="users"></i><span>Customers</span><span class="cnt" id="clientCnt">0</span></button>
                    </div>
                </div>
                <!-- NavDocuments group -->
                <div class="side-group">
                    <div class="side-group-label">Recent</div>
                    <div id="recentList"></div>
                </div>
                <!-- NavSecondary group (mt-auto) -->
                <div class="side-group side-group-secondary">
                    <button class="side-btn" onclick="openGuide()"><i data-lucide="book-open"></i><span>How to use</span></button>
                    <button class="side-btn" onclick="openFeedbackModal()"><i data-lucide="message-square-warning"></i><span>Send feedback</span></button>
                    <button class="side-btn" data-nav="settings" onclick="navigate('/settings')"><i data-lucide="settings"></i><span>Settings</span></button>
                    <button class="side-btn" id="adminNavBtn" data-nav="admin" onclick="navigate('/admin')" style="display:none"><i data-lucide="shield"></i><span>Admin Panel</span></button>
                </div>
            </div>
            <!-- SidebarFooter -->
            <div class="side-foot">
                <button class="side-user-btn" id="sideUserBtn">
                    <div class="side-user-avatar" id="sideUserAvatar" onclick="navigate('/profile')">U</div>
                    <div class="side-user-info" onclick="navigate('/profile')">
                        <span class="side-user-name" id="sideUserName">User</span>
                        <span class="side-user-email" id="sideUserEmail">Settings</span>
                    </div>
                    <i data-lucide="ellipsis-vertical" class="side-user-chevron" onclick="event.stopPropagation();toggleUserMenu()"></i>
                </button>
            </div>
        </aside>

        <!-- Main -->
        <div class="main">
            <div class="topbar">
                <button class="topbar-trigger" id="sidebarTrigger" onclick="toggleSidebar()" aria-label="Toggle sidebar">
                    <i data-lucide="panel-left"></i>
                </button>
                <div class="topbar-sep" aria-hidden="true"></div>
                <div class="topbar-breadcrumb">
                    <span class="breadcrumb-item breadcrumb-root" id="breadcrumbRoot" onclick="navigate('/dashboard')">ProposalKit</span>
                    <i data-lucide="chevron-right" class="breadcrumb-sep"></i>
                    <span class="breadcrumb-item breadcrumb-current" id="topTitle">Dashboard</span>
                </div>
                <span class="sync-indicator" id="syncIndicator" style="display:none"></span>
                <span class="save-indicator" id="saveIndicator" style="display:none" aria-live="polite" role="status">
                    <i data-lucide="loader-2" class="save-icon saving"></i>
                    <i data-lucide="check" class="save-icon saved"></i>
                    <span class="save-text">Saved</span>
                </span>
                <div class="topbar-right" id="topRight">
                    <div class="topbar-search" id="topSearch">
                        <i data-lucide="search"></i>
                        <input type="text" placeholder="Search proposals..." id="searchInput" oninput="filterList()"
                            aria-label="Search proposals">
                        <kbd class="kbd" style="cursor:pointer" onclick="openCommandPalette()"
                            title="Open command palette">⌘K</kbd>
                    </div>
                </div>
            </div>
            <main class="body-scroll" id="bodyScroll" role="main"></main>
        </div>
    </div>

    <!-- Preview -->
    <div class="overlay" id="ov" onclick="closePreview()"></div>
    <div class="preview" id="prevPanel">
        <div class="prev-top">
            <div class="prev-top-label">
                <i data-lucide="eye" class="prev-top-icon"></i>
                <span class="prev-top-t">Preview</span>
            </div>
            <div class="tpl-picker" id="tplPicker">
                <button class="tpl-pick on" onclick="setDocTpl('modern',this)">Modern</button>
                <button class="tpl-pick" onclick="setDocTpl('clean',this)">Clean</button>
                <button class="tpl-pick" onclick="setDocTpl('minimal',this)">Minimal</button>
                <button class="tpl-pick" onclick="setDocTpl('executive',this)">Executive</button>
            </div>
            <div class="prev-top-actions">
                <button class="btn-icon-outline" onclick="typeof showExportMenu==='function'&&showExportMenu(this)" data-tooltip="Export As" data-side="bottom"><i data-lucide="file-down"></i></button>
                <button class="btn-icon-outline" onclick="doExport('invoice')" data-tooltip="Convert to Invoice" data-side="bottom"><i data-lucide="receipt"></i></button>
                <button class="btn-icon-outline" onclick="typeof openDerivativesMenu==='function'&&openDerivativesMenu(this)" data-tooltip="Generate Document" data-side="bottom"><i data-lucide="file-plus-2"></i></button>
                <button class="btn-icon-outline" id="pdfCustomizeBtn" onclick="togglePdfCustomizeDrawer()" data-tooltip="Customize PDF" data-side="bottom"><i data-lucide="palette"></i></button>
                <button class="btn-icon-ghost" onclick="doExport('proposal')" data-tooltip="Download PDF" data-side="bottom"><i data-lucide="download"></i></button>
                <button class="btn-icon-outline" onclick="closePreview()" data-tooltip="Close (Esc)" data-side="bottom"><i data-lucide="x"></i></button>
            </div>
        </div>
        <div class="prev-body">
            <div class="prev-doc" id="prevDoc"></div>
        </div>
    </div>

    <!-- PDF Customize Drawer -->
    <div class="pdf-customize-drawer" id="pdfCustomizeDrawer">
        <div class="pdf-cust-header">
            <div class="pdf-cust-title">
                <i data-lucide="palette"></i>
                <span>Customize PDF</span>
            </div>
            <button class="btn-sm-icon-ghost" onclick="togglePdfCustomizeDrawer()" data-tooltip="Close"><i data-lucide="x"></i></button>
        </div>
        <div class="pdf-cust-body" id="pdfCustomizeBody">
            <!-- Content will be populated dynamically -->
        </div>
    </div>

    <!-- New Proposal Drawer (rendered dynamically by openCreateDrawer) -->

    <!-- Context Menu -->
    <div class="ctx" id="ctxMenu" role="menu" aria-label="Proposal actions">
        <div class="ctx-item" role="menuitem" onclick="ctxAction('open')"><i data-lucide="external-link"></i> Open</div>
        <div class="ctx-item" role="menuitem" onclick="ctxAction('dup')"><i data-lucide="copy"></i> Duplicate</div>
        <div class="ctx-item" role="menuitem" onclick="ctxAction('dupClient')"><i data-lucide="users"></i> Duplicate for Client</div>
        <div class="ctx-item" role="menuitem" onclick="ctxAction('export')"><i data-lucide="download"></i> Export PDF</div>
        <div class="ctx-item" role="menuitem" onclick="ctxAction('invoice')"><i data-lucide="receipt"></i> Export as Invoice</div>
        <div class="ctx-sep" role="separator"></div>
        <div class="ctx-item" role="menuitem" onclick="ctxAction('sow')"><i data-lucide="file-check"></i> Generate SOW</div>
        <div class="ctx-item" role="menuitem" onclick="ctxAction('contract')"><i data-lucide="file-pen"></i> Generate Contract</div>
        <div class="ctx-item" role="menuitem" onclick="ctxAction('receipt')"><i data-lucide="receipt"></i> Generate Receipt</div>
        <div class="ctx-sep" role="separator"></div>
        <div class="ctx-item" role="menuitem" onclick="ctxAction('status')"><i data-lucide="circle-dot"></i> Change Status</div>
        <div class="ctx-sep" role="separator"></div>
        <div class="ctx-item" role="menuitem" id="ctxArchive" onclick="ctxAction('archive')"><i data-lucide="archive"></i> Archive</div>
        <div class="ctx-item" role="menuitem" id="ctxUnarchive" onclick="ctxAction('unarchive')" style="display:none"><i
                data-lucide="archive-restore"></i> Unarchive</div>
        <div class="ctx-item danger" role="menuitem" onclick="ctxAction('del')"><i data-lucide="trash-2"></i> Delete</div>
    </div>

    <!-- Toast -->
    <div class="toasts" id="toastBox" aria-live="assertive" role="alert"></div>

    <!-- Global Loading Indicator -->
    <div class="loading-overlay" id="loadingOverlay" style="display:none">
        <div class="loading-spinner">
            <i data-lucide="loader-2"></i>
            <span id="loadingText">Loading...</span>
        </div>
    </div>

    <!-- QR Code generator (UPI payments, vendored locally) -->
    <script src="assets/js/vendor/qrcode-1.4.4.min.js?v=18"></script>

    <!-- Core: Supabase + Auth + Sync (before store) -->
    <script src="assets/js/core/supabase.js?v=18"></script>
    <script src="assets/js/core/auth.js?v=18"></script>
    <script src="assets/js/core/sync.js?v=18"></script>
    <!-- Core: Foundation -->
    <script src="assets/js/core/store.js?v=18"></script>
    <script src="assets/js/core/utils.js?v=18"></script>
    <script src="assets/js/core/custom-select.js?v=18"></script>
    <script src="assets/js/core/theme.js?v=18"></script>
    <script src="assets/js/core/variables.js?v=18"></script>
    <script src="assets/js/core/modals.js?v=18"></script>
    <script src="assets/js/core/autosave.js?v=18"></script>
    <script src="assets/js/core/sidebar.js?v=19"></script>
    <script src="assets/js/core/command.js?v=18"></script>
    <script src="assets/js/core/shortcuts.js?v=18"></script>
    <script src="assets/js/core/router.js?v=18"></script>
    <script src="assets/js/core/completeness.js?v=18"></script>
    <script src="assets/js/core/error-tracking.js?v=18"></script>
    <script src="assets/js/core/onboarding.js?v=18"></script>
    <script src="assets/js/core/team.js?v=18"></script>
    <!-- SaaS: Support widget, plan enforcement, announcements -->
    <script src="assets/js/core/support.js?v=18"></script>
    <script src="assets/js/core/plans.js?v=18"></script>
    <script src="assets/js/core/announcements.js?v=18"></script>
    <!-- Tiptap Editor (locally bundled — replaces ESM CDN) -->
    <script src="assets/js/vendor/tiptap.bundle.js?v=18"></script>
    <script src="assets/js/editor/tiptap-menus.js?v=18"></script>
    <!-- Editor: Editor tabs & components -->
    <script src="assets/js/editor/focus-mode.js?v=18"></script>
    <!-- Views: Main page views -->
    <script src="assets/js/views/nav.js?v=18"></script>
    <script src="assets/js/views/dashboard.js?v=18"></script>
    <script src="assets/js/views/proposals.js?v=18"></script>
    <script src="assets/js/views/kanban.js?v=18"></script>
    <script src="assets/js/views/analytics.js?v=18"></script>
    <script src="assets/js/views/analytics-breakdowns.js?v=18"></script>
    <!-- Editor: Main editor + all tabs -->
    <script src="assets/js/editor/toc.js?v=18"></script>
    <script src="assets/js/editor/editor.js?v=18"></script>
    <script src="assets/js/editor/details.js?v=18"></script>
    <script src="assets/js/editor/sections.js?v=18"></script>
    <script src="assets/js/editor/ai-assistant.js?v=18"></script>
    <script src="assets/js/editor/structured-sections.js?v=18"></script>
    <script src="assets/js/editor/section-packs.js?v=18"></script>
    <script src="assets/js/editor/pricing.js?v=18"></script>
    <script src="assets/js/editor/tc-library.js?v=18"></script>
    <script src="assets/js/editor/csv-import.js?v=18"></script>
    <script src="assets/js/editor/packages.js?v=18"></script>
    <script src="assets/js/editor/addons.js?v=18"></script>
    <script src="assets/js/editor/payment-schedule.js?v=18"></script>
    <script src="assets/js/editor/payments.js?v=18"></script>
    <script src="assets/js/editor/notes.js?v=18"></script>
    <!-- Export: PDF, preview, sharing -->
    <script src="assets/js/export/preview.js?v=18"></script>
    <script src="assets/js/export/pdf-customizer.js?v=1"></script>
    <script src="assets/js/export/templates.js?v=18"></script>
    <script src="assets/js/export/pdf-templates2.js?v=18"></script>
    <script src="assets/js/export/export.js?v=18"></script>
    <script src="assets/js/export/integrations.js?v=18"></script>
    <script src="assets/js/export/derivatives.js?v=18"></script>
    <script src="assets/js/export/diff-view.js?v=18"></script>
    <script src="assets/js/export/email.js?v=18"></script>
    <script src="assets/js/views/clients.js?v=18"></script>
    <script src="assets/js/views/client-detail.js?v=18"></script>
    <script src="assets/js/export/signature.js?v=18"></script>
    <script src="assets/js/views/settings.js?v=18"></script>
    <script src="assets/js/views/settings-templates.js?v=18"></script>
    <script src="assets/js/views/profile.js?v=18"></script>
    <script src="assets/js/export/tpl-data.js?v=18"></script>
    <script src="assets/js/views/create-page.js?v=18"></script>
    <script src="assets/js/views/create-preview.js?v=18"></script>
    <script src="assets/js/export/sharing.js?v=18"></script>
    <script src="assets/js/export/create.js?v=18"></script>
    <!-- Phase 7: Admin & Subscription Features -->
    <script src="assets/js/core/tickets-queue.js?v=19"></script>
    <script src="assets/js/core/admin-sync.js?v=19"></script>
    <script src="assets/js/views/pricing.js?v=19"></script>
    <script src="assets/js/views/help.js?v=19"></script>
    <script src="assets/js/views/my-tickets.js?v=19"></script>
    <script src="assets/js/views/admin.js?v=19"></script>
    <script src="assets/js/views/admin-users.js?v=19"></script>
    <script src="assets/js/views/admin-tickets.js?v=19"></script>
    <script src="assets/js/views/admin-analytics.js?v=19"></script>
    <!-- Boot: App initialization (always last) -->
    <script src="assets/js/boot.js?v=19"></script>
    <script>
        // Service Worker registration (paid plans only)
        (function() {
            if (!('serviceWorker' in navigator)) return;

            // Service worker update notification flag
            var updateAvailable = false;

            function checkAndManageServiceWorker() {
                // Read subscription from localStorage directly (before app loads)
                var sub = null;
                try {
                    var stored = localStorage.getItem('pk_subscription');
                    sub = stored ? JSON.parse(stored) : null;
                } catch (e) { sub = null; }

                var plan = 'free';
                if (sub && sub.plan && sub.status !== 'cancelled') {
                    var validPlans = ['free', 'pro', 'team'];
                    plan = validPlans.includes(sub.plan) ? sub.plan : 'free';
                }

                var hasOffline = plan === 'pro' || plan === 'team';

                if (hasOffline) {
                    // Register service worker for paid users
                    navigator.serviceWorker.register('/sw.js').then(function(reg) {
                        if (!reg) return;

                        // Check for updates every 60 seconds when page is visible
                        setInterval(function() {
                            if (!document.hidden) reg.update();
                        }, 60000);

                        // Detect when new SW is installing
                        reg.addEventListener('updatefound', function() {
                            var newWorker = reg.installing;
                            if (!newWorker) return;

                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New SW installed, tell it to skip waiting
                                    updateAvailable = true;
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                }
                            });
                        });
                    }).catch(function(err) {
                        console.error('[SW] Registration failed:', err);
                    });

                    // Listen for update ready message from SW
                    navigator.serviceWorker.addEventListener('message', function(e) {
                        if (e.data && e.data.type === 'SW_UPDATED') {
                            console.log('[SW] Update ready, version:', e.data.version);
                            // Show update modal (implemented in boot.js)
                            if (typeof showUpdateModal === 'function') {
                                showUpdateModal();
                            }
                        }
                    });
                } else {
                    // Immediately unregister SW for free users and clear all caches
                    navigator.serviceWorker.getRegistration().then(function(reg) {
                        if (reg) {
                            reg.unregister().then(function() {
                                // Clear all caches after unregistering
                                if ('caches' in window) {
                                    caches.keys().then(function(names) {
                                        names.forEach(function(name) {
                                            console.log('[SW] Clearing cache:', name);
                                            caches.delete(name);
                                        });
                                    });
                                }
                            });
                        }
                    }).catch(function() {});
                }
            }

            // Check immediately on page load
            checkAndManageServiceWorker();

            // Notify active service worker about plan status
            if (navigator.serviceWorker.controller) {
                var sub = null;
                try {
                    var stored = localStorage.getItem('pk_subscription');
                    sub = stored ? JSON.parse(stored) : null;
                } catch (err) { sub = null; }
                var plan = (sub && sub.plan && sub.status !== 'cancelled') ? sub.plan : 'free';
                var hasOffline = plan === 'pro' || plan === 'team';

                navigator.serviceWorker.controller.postMessage({
                    type: 'CHECK_PLAN',
                    hasOffline: hasOffline
                });
            }

            // Prevent PWA installation prompt for free users
            window.addEventListener('beforeinstallprompt', function(e) {
                var sub = null;
                try {
                    var stored = localStorage.getItem('pk_subscription');
                    sub = stored ? JSON.parse(stored) : null;
                } catch (err) { sub = null; }
                var plan = (sub && sub.plan && sub.status !== 'cancelled') ? sub.plan : 'free';
                var hasOffline = plan === 'pro' || plan === 'team';

                if (!hasOffline) {
                    e.preventDefault(); // Block install prompt for free users
                    if (typeof showUpgradeModal === 'function') {
                        showUpgradeModal('offline', {allowed: false, plan: 'free'});
                    }
                }
            });
        })();
        // Offline / Online detection banner
        (function() {
            function showOfflineBanner() {
                if (document.getElementById('offlineBanner')) return;
                var plan = typeof getCurrentPlan === 'function' ? getCurrentPlan() : 'free';
                var hasOffline = plan === 'pro' || plan === 'team';
                var b = document.createElement('div');
                b.id = 'offlineBanner';
                b.setAttribute('role', 'alert');
                b.style.cssText = 'position:fixed;bottom:0;left:0;right:0;z-index:99999;background:' + (hasOffline ? '#18181b' : '#FF3B30') + ';color:#fff;text-align:center;padding:10px 16px;font-size:13px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;display:flex;align-items:center;justify-content:center;gap:8px';
                if (hasOffline) {
                    b.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h.01"/><path d="M8.5 16.429a5 5 0 0 1 7 0"/><path d="M2 8.82a15 15 0 0 1 4.17-2.65"/><path d="M10.66 5c4.01-.36 8.14.9 11.34 3.76"/><path d="M16.85 11.25a10 10 0 0 1 2.22 1.68"/><path d="M5 12.859a10 10 0 0 1 5.17-2.69"/><line x1="2" y1="2" x2="22" y2="22"/></svg> You\'re offline — changes are saved locally and will sync when you reconnect';
                } else {
                    b.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 0v8l4 4"/></svg> You\'re offline — <strong>Offline access is a Pro feature.</strong> <button onclick="if(typeof showUpgradeModal===\'function\')showUpgradeModal(\'offline\',{allowed:false,plan:\'free\'});else window.open(\'https://proposalkit.com/pricing\',\'_blank\')" style="background:none;border:1px solid #fff;color:#fff;padding:4px 12px;border-radius:9999px;margin-left:8px;cursor:pointer;font-size:12px;font-weight:500">Upgrade</button>';
                }
                document.body.appendChild(b);
            }
            function hideOfflineBanner() {
                var b = document.getElementById('offlineBanner');
                if (b) b.remove();
            }
            window.addEventListener('offline', showOfflineBanner);
            window.addEventListener('online', hideOfflineBanner);
            if (!navigator.onLine) showOfflineBanner();
        })();
    </script>

</body>

</html>