<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Proposal</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --white: #fff;
            --bg: #f7f7f8;
            --card: #fff;
            --muted: #f4f4f5;
            --hover: #ececed;
            --active: #e4e4e5;
            --border: #e4e4e7;
            --border-h: #d4d4d8;
            --ring: #18181b;
            --text: #09090b;
            --text2: #3f3f46;
            --text3: #71717a;
            --text4: #a1a1aa;
            --text5: #d4d4d8;
            --black: #18181b;
            --black-fg: #fff;
            --blue: #007AFF;
            --blue-h: #0066D6;
            --blue-bg: #eff6ff;
            --green: #34C759;
            --green-bg: #f0fdf4;
            --red: #FF3B30;
            --red-bg: #fef2f2;
            --amber: #FF9500;
            --amber-bg: #fffbeb;
            --r: 8px;
            --r2: 10px;
            --r3: 12px;
            --font: 'Inter', system-ui, sans-serif;
            --mono: 'JetBrains Mono', monospace;
            --t: 150ms ease-out;
            --sh: 0 1px 2px rgba(0, 0, 0, .05);
            --sh2: 0 4px 16px rgba(0, 0, 0, .07);
            --sh3: 0 16px 48px rgba(0, 0, 0, .1);
        }

        html {
            font-size: 14px;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::selection {
            background: rgba(0, 122, 255, 0.15);
            color: inherit;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .loading,
        .error,
        .not-found,
        .responded {
            text-align: center;
            padding: 80px 20px;
        }

        .loading-icon,
        .error-icon,
        .responded-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
        }

        .loading-icon {
            color: var(--blue);
            animation: spin 1s linear infinite;
        }

        .error-icon {
            color: var(--red);
        }

        .responded-icon.accepted {
            color: var(--green);
        }

        .responded-icon.declined {
            color: var(--text3);
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .loading-t,
        .error-t,
        .responded-t {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-d,
        .error-d,
        .responded-d {
            color: var(--text3);
            font-size: 14px;
        }

        /* Header */
        .header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-img {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            object-fit: cover;
        }

        .logo-text {
            font-weight: 600;
            font-size: 15px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        /* Print styles */
        @media print {
            .header, .action-bar { display: none !important; }
            .container { padding: 0; max-width: 100%; }
            .prop-card { border: none; box-shadow: none; }
        }

        /* Proposal Card */
        .prop-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r2);
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--sh);
        }

        .prop-cover {
            height: 180px;
            background: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text4);
            font-size: 48px;
            font-weight: 700;
        }

        .prop-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .prop-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .prop-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .prop-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            color: var(--text3);
            font-size: 13px;
        }

        .prop-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .prop-meta-item i {
            width: 14px;
            height: 14px;
        }

        /* Sections */
        .section-card {
            border-bottom: 1px solid var(--border);
            padding: 24px;
        }

        .section-card:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            width: 20px;
            height: 20px;
            color: var(--blue);
        }

        .section-content {
            color: var(--text2);
            font-size: 14px;
            line-height: 1.7;
        }

        .section-content p {
            margin-bottom: 12px;
        }

        .section-content ul,
        .section-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .section-content li {
            margin-bottom: 4px;
        }

        /* Pricing Table */
        .pricing-section {
            padding: 24px;
        }

        .pricing-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .pricing-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pricing-table th {
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text4);
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
        }

        .pricing-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .pricing-table tr:last-child td {
            border-bottom: none;
        }

        .pricing-table .amount {
            text-align: right;
            font-weight: 600;
            font-family: var(--mono);
        }

        .pricing-summary {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid var(--border);
        }

        .pricing-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
        }

        .pricing-row.total {
            font-size: 18px;
            font-weight: 700;
            padding-top: 12px;
            margin-top: 8px;
            border-top: 1px solid var(--border);
        }

        /* Action Bar */
        .action-bar {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 24px;
            text-align: center;
            position: sticky;
            bottom: 20px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        .action-bar-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .action-bar-desc {
            color: var(--text3);
            font-size: 13px;
            margin-bottom: 16px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ═══ BUTTONS ═══ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 36px;
            padding: 0 16px;
            border-radius: 9999px;
            font-family: var(--font);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--t);
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(.97);
        }

        .btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 24, 27, .06);
        }

        .btn i {
            width: 16px;
            height: 16px;
        }

        .btn-dark {
            background: var(--black);
            color: var(--black-fg);
        }

        .btn-dark:hover {
            background: #27272a;
        }

        .btn-out {
            background: var(--white);
            color: var(--text);
            border-color: var(--border);
        }

        .btn-out:hover {
            background: var(--muted);
            border-color: var(--border-h);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text3);
            border: none;
        }

        .btn-ghost:hover {
            background: var(--muted);
            color: var(--text);
        }

        .btn-primary {
            background: var(--black);
            color: var(--black-fg);
            border: none;
        }

        .btn-primary:hover {
            background: #27272a;
        }

        .btn-red {
            background: var(--red-bg);
            color: var(--red);
            border: none;
        }

        .btn-red:hover {
            background: #fee2e2;
        }

        .btn-sm {
            height: 32px;
            padding: 0 12px;
            font-size: 12px;
        }

        .btn-sm i {
            width: 14px;
            height: 14px;
        }

        /* Comment Modal */
        .modal-wrap {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-wrap.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-t {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-d {
            color: var(--text3);
            font-size: 13px;
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text3);
        }

        .textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
        }

        .modal-foot {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Acceptance Block */
        .accept-field {
            margin-bottom: 16px;
        }

        .accept-field label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text3);
        }

        .accept-field input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--background);
            color: var(--text);
        }

        .accept-field input:focus {
            outline: none;
            border-color: var(--black);
            box-shadow: 0 0 0 2px rgba(24, 24, 27, 0.06);
        }

        .sig-canvas-wrap {
            position: relative;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: var(--white);
        }

        .sig-canvas-wrap canvas {
            display: block;
            width: 100%;
            cursor: crosshair;
        }

        .sig-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text4);
            font-size: 13px;
            pointer-events: none;
        }

        .sig-clear-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: var(--muted);
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text3);
        }

        .sig-clear-btn:hover {
            background: var(--border);
        }

        .accept-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            color: var(--text2);
            cursor: pointer;
        }

        .accept-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-top: 1px;
            flex-shrink: 0;
            accent-color: var(--black);
        }

        /* Section nav for quick jumping */
        .section-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
        }
        .section-nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 9999px;
            border: 1px solid var(--border);
            background: var(--card);
            font-family: var(--font);
            font-size: 12px;
            font-weight: 500;
            color: var(--text3);
            cursor: pointer;
            transition: all var(--t);
        }
        .section-nav-btn:hover { background: var(--muted); color: var(--text); border-color: var(--border-h); }
        .section-nav-btn i { width: 12px; height: 12px; }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 20px 16px;
            }

            .prop-header {
                padding: 16px;
            }

            .section-card {
                padding: 16px;
            }

            .pricing-section {
                padding: 16px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="loading">
            <i data-lucide="loader-2" class="loading-icon"></i>
            <div class="loading-t">Loading Proposal</div>
            <div class="loading-d">Please wait...</div>
        </div>
    </div>

    <script>
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('p');

        // Load proposal data from localStorage (shared with main app)
        let DB = JSON.parse(localStorage.getItem('pk_db') || '[]');
        let CONFIG = JSON.parse(localStorage.getItem('pk_config') || 'null');
        let proposal = null;

        function esc(s) { return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
        function sanitizeHtml(html) {
            if (!html || typeof html !== 'string') return '';
            const div = document.createElement('div');
            div.innerHTML = html;
            div.querySelectorAll('script,iframe,object,embed,form,style,link,meta,base,svg').forEach(el => el.remove());
            div.querySelectorAll('*').forEach(el => {
                [...el.attributes].forEach(attr => {
                    const name = attr.name.toLowerCase();
                    if (name.startsWith('on') || name === 'srcdoc' || name === 'formaction' || name === 'xlink:href') el.removeAttribute(attr.name);
                    if (name === 'href' || name === 'src' || name === 'action') {
                        const val = (attr.value || '').trim().toLowerCase();
                        if (val.startsWith('javascript:') || val.startsWith('data:text') || val.startsWith('vbscript:')) el.removeAttribute(attr.name);
                    }
                });
            });
            return div.innerHTML;
        }
        function fmtCur(n, c) {
            const currency = c || '₹';
            const displayCurrency = currency === '¥CN' ? '¥' : currency;
            const val = (typeof n === 'number' && isFinite(n)) ? n : 0;
            const locale = (currency === '₹') ? 'en-IN' : 'en-US';
            return displayCurrency + val.toLocaleString(locale);
        }
        function fmtDate(d) {
            if (!d) return '—';
            const dt = new Date(d);
            const isIN = CONFIG?.country === 'IN';
            return dt.toLocaleDateString(isIN ? 'en-IN' : 'en-US', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // persist() removed — client page is read-only to prevent data tampering

        function init() {
            if (!token) {
                showError('Invalid Link', 'This proposal link is invalid or expired.');
                return;
            }

            proposal = DB.find(p => p.shareToken === token);
            if (!proposal) {
                showError('Proposal Not Found', 'This proposal may have been deleted or the link is incorrect.');
                return;
            }

            // Check if already responded
            if (proposal.clientResponse) {
                showResponded(proposal.clientResponse.status);
                return;
            }

            // View tracking is handled server-side in production
            // Client page is read-only to prevent localStorage tampering

            renderProposal();
        }

        function showError(title, message) {
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="error">
                        <i data-lucide="alert-triangle" class="error-icon"></i>
                        <div class="error-t">${esc(title)}</div>
                        <div class="error-d">${esc(message)}</div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function showResponded(status) {
            const isAccepted = status === 'accepted';
            const cr = proposal.clientResponse || {};
            const sigImg = cr.clientSignature?.startsWith('data:image/') ? cr.clientSignature : '';
            document.getElementById('app').innerHTML = `
                <div class="container">
                    <div class="responded">
                        <i data-lucide="${isAccepted ? 'check-circle-2' : 'x-circle'}" class="responded-icon ${status}"></i>
                        <div class="responded-t">Proposal ${isAccepted ? 'Accepted' : 'Declined'}</div>
                        <div class="responded-d">
                            ${isAccepted
                    ? 'Thank you! Your acceptance has been recorded. The sender has been notified.'
                    : 'This proposal has been declined. The sender has been notified.'}
                        </div>
                        ${isAccepted && (cr.clientName || sigImg) ? `
                            <div style="margin-top:24px;padding:20px;background:var(--muted);border-radius:12px;text-align:left;max-width:400px;margin-left:auto;margin-right:auto">
                                <div style="font-size:12px;font-weight:600;color:var(--text4);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Acceptance Record</div>
                                ${cr.clientName ? `<div style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px">${esc(cr.clientName)}</div>` : ''}
                                <div style="font-size:12px;color:var(--text3);margin-bottom:12px">${new Date(cr.respondedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                ${sigImg ? `<img src="${sigImg}" alt="Client signature" style="max-width:200px;height:auto;border-bottom:1px solid var(--border);padding-bottom:8px">` : ''}
                            </div>
                        ` : ''}
                        ${cr.comment ? `
                            <div style="margin-top:16px;padding:16px;background:var(--muted);border-radius:8px;text-align:left;max-width:400px;margin-left:auto;margin-right:auto">
                                <div style="font-size:12px;font-weight:600;color:var(--text4);margin-bottom:4px">Your comment:</div>
                                <div style="color:var(--text2);font-size:14px">${esc(cr.comment)}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderProposal() {
            const p = proposal;
            const total = (p.lineItems || []).reduce((sum, item) => sum + (item.qty || 0) * (item.rate || 0), 0);
            const discount = p.discount || 0;
            const taxRate = p.taxRate || 0;
            const taxAmount = (total - discount) * (taxRate / 100);
            const grandTotal = total - discount + taxAmount;

            // Build section navigation
            const sectionNav = (p.sections || []).length > 1
                ? `<div class="section-nav">${(p.sections || []).map((s, i) => `<button class="section-nav-btn" onclick="document.getElementById('sec-${i}').scrollIntoView({behavior:'smooth',block:'start'})"><i data-lucide="${getSectionIcon(s.type)}"></i> ${esc(s.title)}</button>`).join('')}${(p.lineItems || []).length ? '<button class="section-nav-btn" onclick="document.querySelector(\'.pricing-section\').scrollIntoView({behavior:\'smooth\',block:\'start\'})"><i data-lucide="banknote"></i> Pricing</button>' : ''}</div>`
                : '';

            // Build sections HTML
            let sectionsHtml = (p.sections || []).map((s, i) => `
                <div class="section-card" id="sec-${i}">
                    <div class="section-title">
                        <i data-lucide="${getSectionIcon(s.type)}"></i>
                        ${esc(s.title)}
                    </div>
                    <div class="section-content">
                        ${formatContent(s.content)}
                    </div>
                </div>
            `).join('');

            // Build pricing table
            let pricingHtml = '';
            if (p.lineItems && p.lineItems.length > 0) {
                const rows = p.lineItems.map(item => `
                    <tr>
                        <td>${esc(item.desc)}</td>
                        <td>${item.qty}</td>
                        <td>${fmtCur(item.rate, p.currency)}</td>
                        <td class="amount">${fmtCur(item.qty * item.rate, p.currency)}</td>
                    </tr>
                `).join('');

                pricingHtml = `
                    <div class="pricing-section">
                        <div class="pricing-title">Investment</div>
                        <table class="pricing-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Rate</th>
                                    <th style="text-align:right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                        <div class="pricing-summary">
                            <div class="pricing-row">
                                <span>Subtotal</span>
                                <span>${fmtCur(total, p.currency)}</span>
                            </div>
                            ${discount > 0 ? `<div class="pricing-row"><span>Discount</span><span>-${fmtCur(discount, p.currency)}</span></div>` : ''}
                            ${taxRate > 0 ? `<div class="pricing-row"><span>Tax (${taxRate}%)</span><span>${fmtCur(taxAmount, p.currency)}</span></div>` : ''}
                            <div class="pricing-row total">
                                <span>Total</span>
                                <span>${fmtCur(grandTotal, p.currency)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('app').innerHTML = `
                <header class="header">
                    <div class="header-inner">
                        <div class="logo">
                            ${CONFIG?.logo ? `<img src="${esc(CONFIG.logo)}" class="logo-img">` : ''}
                            <span class="logo-text">${esc(p.sender?.company || CONFIG?.company || '')}</span>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-out btn-sm" onclick="window.print()"><i data-lucide="printer"></i> Print</button>
                        </div>
                    </div>
                </header>
                
                <div class="container">
                    <div class="prop-card">
                        ${p.coverPhoto ? `<div class="prop-cover"><img src="${esc(p.coverPhoto)}"></div>` : ''}

                        ${sectionNav}
                        <div class="prop-header">
                            <div class="prop-title">${esc(p.title)}</div>
                            <div class="prop-meta">
                                <div class="prop-meta-item">
                                    <i data-lucide="hash"></i>
                                    ${esc(p.number)}
                                </div>
                                <div class="prop-meta-item">
                                    <i data-lucide="calendar"></i>
                                    ${fmtDate(p.date)}
                                </div>
                                ${p.validUntil ? `
                                    <div class="prop-meta-item">
                                        <i data-lucide="clock"></i>
                                        Valid until ${fmtDate(p.validUntil)}
                                    </div>
                                ` : ''}
                                <div class="prop-meta-item">
                                    <i data-lucide="user"></i>
                                    For: ${esc(p.client?.name || 'Client')}
                                </div>
                            </div>
                        </div>
                        
                        ${sectionsHtml}
                        ${pricingHtml}
                    </div>

                    <div class="action-bar">
                        <div class="action-bar-title">Ready to proceed?</div>
                        <div class="action-bar-desc">Review the proposal above and let us know your decision.</div>
                        <div class="action-buttons">
                            <button class="btn btn-dark" onclick="showAcceptModal()">
                                <i data-lucide="check"></i>
                                Accept Proposal
                            </button>
                            <button class="btn btn-out" onclick="showDeclineModal()">
                                <i data-lucide="x"></i>
                                Decline
                            </button>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function getSectionIcon(type) {
            const icons = {
                'intro': 'file-text',
                'scope': 'list-checks',
                'timeline': 'calendar',
                'team': 'users',
                'terms': 'shield',
                'default': 'layers'
            };
            return icons[type] || icons.default;
        }

        function formatContent(content) {
            if (!content) return '';

            // Handle plain string content
            if (typeof content === 'string') {
                let html = esc(content);
                html = html.split('\n\n').map(p => `<p>${p}</p>`).join('');
                html = html.replace(/\n/g, '<br>');
                return html;
            }

            // Handle Editor.js block format (sanitize to prevent XSS)
            if (content.blocks && Array.isArray(content.blocks)) {
                return content.blocks.map(block => {
                    if (block.type === 'paragraph') {
                        return `<p>${sanitizeHtml(block.data.text || '')}</p>`;
                    }
                    if (block.type === 'header') {
                        const level = Math.min(6, Math.max(1, block.data.level || 2));
                        return `<h${level}>${sanitizeHtml(block.data.text || '')}</h${level}>`;
                    }
                    if (block.type === 'list') {
                        const tag = block.data.style === 'ordered' ? 'ol' : 'ul';
                        const items = (block.data.items || []).map(item => {
                            const text = typeof item === 'string' ? item : (item.content || '');
                            return `<li>${sanitizeHtml(text)}</li>`;
                        }).join('');
                        return `<${tag}>${items}</${tag}>`;
                    }
                    if (block.type === 'checklist') {
                        const items = (block.data.items || []).map(item => {
                            const checked = item.checked ? '✓' : '○';
                            return `<li>${checked} ${sanitizeHtml(item.text || '')}</li>`;
                        }).join('');
                        return `<ul style="list-style:none;padding-left:0">${items}</ul>`;
                    }
                    return '';
                }).join('');
            }

            return '';
        }


        function showAcceptModal() {
            showResponseModal('accept');
        }

        function showDeclineModal() {
            showResponseModal('decline');
        }

        function showResponseModal(type) {
            const isAccept = type === 'accept';
            const modal = document.createElement('div');
            modal.className = 'modal-wrap show';
            modal.id = 'responseModal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div class="modal" style="max-width:${isAccept ? '480px' : '400px'}" onclick="event.stopPropagation()">
                    <div class="modal-t">${isAccept ? 'Accept Proposal' : 'Decline Proposal'}</div>
                    <div class="modal-d">${isAccept
                    ? 'Type your name and sign below to formally accept this proposal.'
                    : 'We\'re sorry to hear that. Please let us know why (optional).'}</div>
                    ${isAccept ? `
                    <div class="accept-field">
                        <label>Full Name</label>
                        <input type="text" id="acceptName" placeholder="Type your full name" value="${esc(proposal.client?.name || '')}">
                    </div>
                    <div class="accept-field">
                        <label>Signature</label>
                        <div class="sig-canvas-wrap">
                            <canvas id="acceptSigCanvas" width="440" height="120"></canvas>
                            <div class="sig-placeholder" id="sigPlaceholder">Draw your signature here</div>
                            <button class="sig-clear-btn" onclick="clearAcceptSig()">Clear</button>
                        </div>
                    </div>
                    <label class="accept-checkbox">
                        <input type="checkbox" id="acceptTerms">
                        I have reviewed and accept the terms of this proposal.
                    </label>
                    ` : ''}
                    <div style="margin-bottom:16px">
                        <label class="form-label">Comment (optional)</label>
                        <textarea class="textarea" id="responseComment" placeholder="${isAccept
                    ? 'Looking forward to working together!'
                    : 'The budget doesn\'t fit our current needs...'}"></textarea>
                    </div>
                    <div class="modal-foot">
                        <button class="btn btn-out btn-sm" onclick="document.getElementById('responseModal').remove()">Cancel</button>
                        <button class="btn ${isAccept ? 'btn-dark' : 'btn-out'} btn-sm" id="submitBtn" onclick="submitResponse('${type}')">
                            ${isAccept ? 'Accept & Sign' : 'Decline'}
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            if (isAccept) setupAcceptSigCanvas();
        }

        function setupAcceptSigCanvas() {
            const canvas = document.getElementById('acceptSigCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let drawing = false, lastX = 0, lastY = 0, hasDrawn = false;
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = ((e.touches ? e.touches[0].clientX : e.clientX) - rect.left) * scaleX;
                const y = ((e.touches ? e.touches[0].clientY : e.clientY) - rect.top) * scaleY;
                return { x, y };
            };
            const start = (e) => { drawing = true; const pos = getPos(e); lastX = pos.x; lastY = pos.y; };
            const draw = (e) => {
                if (!drawing) return; e.preventDefault();
                const pos = getPos(e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke();
                lastX = pos.x; lastY = pos.y;
                if (!hasDrawn) { hasDrawn = true; const ph = document.getElementById('sigPlaceholder'); if (ph) ph.style.display = 'none'; }
            };
            const stop = () => { drawing = false; };
            canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop); canvas.addEventListener('mouseleave', stop);
            canvas.addEventListener('touchstart', start, { passive: false }); canvas.addEventListener('touchmove', draw, { passive: false }); canvas.addEventListener('touchend', stop);
            canvas._hasDrawn = () => hasDrawn;
        }

        function clearAcceptSig() {
            const canvas = document.getElementById('acceptSigCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const ph = document.getElementById('sigPlaceholder'); if (ph) ph.style.display = '';
            canvas._hasDrawn = () => false;
            setupAcceptSigCanvas();
        }

        function submitResponse(type) {
            const comment = document.getElementById('responseComment')?.value || '';
            const status = type === 'accept' ? 'accepted' : 'declined';

            let clientName = '', clientSignature = '';
            if (type === 'accept') {
                clientName = document.getElementById('acceptName')?.value?.trim() || '';
                const terms = document.getElementById('acceptTerms');
                const canvas = document.getElementById('acceptSigCanvas');

                if (!clientName) { alert('Please enter your full name.'); document.getElementById('acceptName')?.focus(); return; }
                if (!terms?.checked) { alert('Please check the acceptance checkbox.'); return; }
                if (canvas && canvas._hasDrawn && !canvas._hasDrawn()) { alert('Please draw your signature.'); return; }
                if (canvas) clientSignature = canvas.toDataURL('image/png');
            }

            // Store response in a separate key — main app merges on next load
            try {
                const responses = JSON.parse(localStorage.getItem('pk_client_responses') || '[]');
                const response = {
                    proposalId: proposal.id,
                    token: token,
                    status: status,
                    respondedAt: Date.now(),
                    comment: comment
                };
                if (clientName) response.clientName = clientName;
                if (clientSignature) response.clientSignature = clientSignature;
                responses.push(response);
                localStorage.setItem('pk_client_responses', JSON.stringify(responses));
            } catch (e) { /* storage full */ }

            proposal.clientResponse = { status, respondedAt: Date.now(), comment, clientName, clientSignature };

            document.getElementById('responseModal').remove();
            showResponded(status);
        }

        // Initialize
        init();
        lucide.createIcons();
    </script>
</body>

</html>