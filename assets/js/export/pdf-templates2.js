// ════════════════════════════════════════
// PDF TEMPLATES — Extended set (sleek, global)
// ════════════════════════════════════════

/* exported buildExecutiveTpl, buildCompactTpl, buildBoldTpl, buildSidebarTpl, buildStripeTpl, buildFormalTpl, buildCleanTpl, buildNordTpl, buildAmericanTpl, loc */
function buildExecutiveTpl(p, c, bc, t, rows, secs, logo, title, num, isInv) {
    const ver = p.version > 1 ? ` · v${p.version}` : '';
    let h = `<div style="border-bottom:3px solid ${bc};padding-bottom:20px;margin-bottom:28px;display:flex;justify-content:space-between;align-items:flex-end">${logo}<div style="text-align:right"><div style="font-size:28px;font-weight:800;color:#09090b;letter-spacing:-1px">${title}</div><div style="font-size:12px;color:#a1a1aa;margin-top:2px">${num}${ver} · ${fmtDate(p.date)}</div></div></div>`;
    h += `<div style="display:flex;gap:40px;margin-bottom:32px;page-break-inside:avoid;break-inside:avoid"><div style="flex:1"><div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;color:${bc};margin-bottom:6px">Prepared by</div><div style="font-size:14px;font-weight:600;color:#800020">${esc(p.sender.company)}</div><div style="font-size:12px;color:#71717a;margin-top:4px;line-height:1.6">${buildSenderDetails()}</div>${buildSenderTaxLine()}</div><div style="flex:1"><div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;color:${bc};margin-bottom:6px">${isInv ? 'Billed to' : 'Prepared for'}</div><div style="font-size:14px;font-weight:600;color:#800020">${esc(p.client.name)}</div><div style="font-size:12px;color:#71717a;margin-top:4px;line-height:1.6">${buildClientDetails(p.client)}</div></div><div><div style="font-size:9px;text-transform:uppercase;letter-spacing:1.2px;font-weight:700;color:${bc};margin-bottom:6px">${isInv ? 'Amount Due' : 'Total Value'}</div><div style="font-size:24px;font-weight:800;color:${bc};font-family:'JetBrains Mono',monospace">${fmtCur(t.grand, c)}</div><div style="font-size:11px;color:#a1a1aa;margin-top:2px">${isInv ? 'Due' : 'Valid'}: ${fmtDate(p.validUntil)}</div></div></div>`;
    if (!isInv) secs.forEach(s => { if (s.type && typeof buildStructuredSectionPdf === 'function') { h += buildStructuredSectionPdf(s, bc); } else { h += `<div style="margin-bottom:24px"><div style="font-size:13px;font-weight:700;color:#09090b;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid #e4e4e7">${esc(s.title)}</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(s.content, p)}</div></div>`; } });
    if (rows.length) { h += `<div style="font-size:13px;font-weight:700;color:#09090b;margin:24px 0 8px;padding-bottom:4px;border-bottom:1px solid #e4e4e7">${isInv ? 'Items' : 'Pricing'}</div>`; h += buildPricingHtml(rows, c, t, bc, 'modern'); }
    if (p.paymentTerms) h += `<div style="font-size:13px;font-weight:700;color:#09090b;margin:24px 0 6px;padding-bottom:4px;border-bottom:1px solid #e4e4e7">Payment Terms</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(p.paymentTerms, p)}</div>`;
    h += buildBankFooterHtml(bc);
    return h;
}

function buildCompactTpl(p, c, bc, t, rows, secs, logo, title, num, isInv) {
    let h = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">${logo}<div style="background:${bc};color:#fff;padding:6px 14px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.5px">${isInv ? 'INVOICE' : 'PROPOSAL'}</div></div>`;
    h += `<div style="font-size:20px;font-weight:800;color:#09090b;margin-bottom:2px">${title}</div>`;
    h += `<div style="font-size:11px;color:#a1a1aa;margin-bottom:20px">${num} · ${fmtDate(p.date)}${p.version > 1 ? ' · v' + p.version : ''}</div>`;
    h += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px;font-size:12px;page-break-inside:avoid;break-inside:avoid">`;
    h += `<div style="background:#fafafa;padding:12px;border-radius:6px"><span style="color:#a1a1aa">From:</span> <strong>${esc(p.sender.company)}</strong><br><span style="color:#71717a">${buildSenderDetails()}</span>${buildSenderTaxLine()}</div>`;
    h += `<div style="background:#fafafa;padding:12px;border-radius:6px"><span style="color:#a1a1aa">${isInv ? 'Bill To:' : 'To:'}</span> <strong>${esc(p.client.name)}</strong><br><span style="color:#71717a">${buildClientDetails(p.client)}</span></div></div>`;
    if (!isInv) secs.forEach(s => { if (s.type && typeof buildStructuredSectionPdf === 'function') { h += buildStructuredSectionPdf(s, bc); } else { h += `<div style="margin-bottom:24px"><div style="font-size:12px;font-weight:700;color:${bc};margin-bottom:4px">${esc(s.title)}</div><div style="color:#52525b;font-size:12px;line-height:1.6">${editorJsToHtml(s.content, p)}</div></div>`; } });
    if (rows.length) { h += `<div style="font-size:12px;font-weight:700;color:${bc};margin:24px 0 6px">${isInv ? 'Items' : 'Pricing'}</div>`; h += buildPricingHtml(rows, c, t, bc, 'modern'); }
    if (p.paymentTerms) h += `<div style="font-size:12px;font-weight:700;color:${bc};margin:24px 0 4px">Terms</div><div style="color:#71717a;font-size:11px;line-height:1.6">${editorJsToHtml(p.paymentTerms, p)}</div>`;
    h += buildBankFooterHtml(bc);
    return h;
}

function buildBoldTpl(p, c, bc, t, rows, secs, logo, title, num, isInv) {
    let h = `<div style="background:${bc};color:#fff;padding:28px 24px;margin:-20px -20px 28px;border-radius:0 0 12px 12px"><div style="display:flex;justify-content:space-between;align-items:flex-start">${logo ? logo.replace(/style="([^"]*)"/, 'style="max-height:32px;filter:brightness(0) invert(1)"') : ''}<div style="text-align:right;font-size:11px;opacity:.7">${num}${p.version > 1 ? ' · v' + p.version : ''}<br>${fmtDate(p.date)}</div></div><div style="font-size:28px;font-weight:900;margin-top:14px;letter-spacing:-1px">${title}</div><div style="display:flex;gap:24px;margin-top:16px;font-size:12px;opacity:.8"><div><strong>For:</strong> ${esc(p.client.name)}</div><div><strong>${isInv ? 'Due:' : 'Valid:'}</strong> ${fmtDate(p.validUntil)}</div><div><strong>Total:</strong> <span style="font-family:'JetBrains Mono',monospace">${fmtCur(t.grand, c)}</span></div></div></div>`;
    h += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:28px;font-size:12px;page-break-inside:avoid;break-inside:avoid"><div><div style="font-weight:700;color:${bc};font-size:10px;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px">From</div>${esc(p.sender.company)}<br><span style="color:#71717a">${buildSenderDetails()}</span>${buildSenderTaxLine()}</div><div><div style="font-weight:700;color:${bc};font-size:10px;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px">${isInv ? 'Bill To' : 'Client'}</div>${esc(p.client.name)}<br><span style="color:#71717a">${buildClientDetails(p.client)}</span></div></div>`;
    if (!isInv) secs.forEach(s => { if (s.type && typeof buildStructuredSectionPdf === 'function') { h += buildStructuredSectionPdf(s, bc); } else { h += `<div style="margin-bottom:24px"><div style="font-size:14px;font-weight:800;color:#09090b;margin-bottom:6px">${esc(s.title)}</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(s.content, p)}</div></div>`; } });
    if (rows.length) { h += `<div style="font-size:14px;font-weight:800;color:#09090b;margin:24px 0 8px">Pricing</div>`; h += buildPricingHtml(rows, c, t, bc, 'modern'); }
    if (p.paymentTerms) h += `<div style="font-size:14px;font-weight:800;color:#09090b;margin:24px 0 6px">Payment Terms</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(p.paymentTerms, p)}</div>`;
    h += buildBankFooterHtml(bc);
    return h;
}

function buildSidebarTpl(p, c, bc, t, rows, secs, logo, title, num, isInv) {
    const ver = p.version > 1 ? ' · v' + p.version : '';
    const sidebar = `<div style="width:200px;flex-shrink:0;padding:20px;background:#fafafa;border-right:1px solid #e4e4e7">${logo}<div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:${bc};margin:16px 0 4px">From</div><div style="font-size:12px;font-weight:600">${esc(p.sender.company)}</div><div style="font-size:11px;color:#71717a;margin-top:2px;line-height:1.5">${buildSenderDetails()}</div>${buildSenderTaxLine()}<div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:${bc};margin:16px 0 4px">${isInv ? 'Bill To' : 'Client'}</div><div style="font-size:12px;font-weight:600">${esc(p.client.name)}</div><div style="font-size:11px;color:#71717a;margin-top:2px;line-height:1.5">${buildClientDetails(p.client)}</div><div style="font-size:9px;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:${bc};margin:16px 0 4px">Details</div><div style="font-size:11px;color:#52525b;line-height:1.6">${num}${ver}<br>${fmtDate(p.date)}<br>${isInv ? 'Due' : 'Valid'}: ${fmtDate(p.validUntil)}</div><div style="margin-top:16px;padding:12px;background:${bc}0D;border-radius:6px"><div style="font-size:9px;text-transform:uppercase;letter-spacing:.8px;font-weight:700;color:${bc}">Total</div><div style="font-size:18px;font-weight:800;color:${bc};font-family:'JetBrains Mono',monospace;margin-top:2px">${fmtCur(t.grand, c)}</div></div></div>`;
    let main = `<div style="flex:1;padding:20px"><div style="font-size:22px;font-weight:800;color:#09090b;letter-spacing:-.5px;margin-bottom:20px">${title}</div>`;
    if (!isInv) secs.forEach(s => { if (s.type && typeof buildStructuredSectionPdf === 'function') { main += buildStructuredSectionPdf(s, bc); } else { main += `<div style="margin-bottom:24px"><div style="font-size:12px;font-weight:700;color:${bc};margin-bottom:4px">${esc(s.title)}</div><div style="color:#52525b;font-size:12px;line-height:1.7">${editorJsToHtml(s.content, p)}</div></div>`; } });
    if (rows.length) { main += `<div style="font-size:12px;font-weight:700;color:${bc};margin:24px 0 6px">Pricing</div>`; main += buildPricingHtml(rows, c, t, bc, 'modern'); }
    if (p.paymentTerms) main += `<div style="font-size:12px;font-weight:700;color:${bc};margin:24px 0 4px">Terms</div><div style="color:#71717a;font-size:11px;line-height:1.6">${editorJsToHtml(p.paymentTerms, p)}</div>`;
    main += buildBankFooterHtml(bc);
    main += '</div>';
    return `<div style="display:flex;margin:-20px;min-height:600px">${sidebar}${main}</div>`;
}

function buildStripeTpl(p, c, bc, t, rows, secs, logo, title, num, isInv) {
    let h = `<div style="height:6px;background:linear-gradient(90deg,${bc},${bc}88);margin:-20px -20px 24px;border-radius:0"></div>`;
    h += `<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px">${logo}<div style="text-align:right"><div style="font-size:11px;color:#a1a1aa">${num}${p.version > 1 ? ' · v' + p.version : ''}</div><div style="font-size:11px;color:#a1a1aa">${fmtDate(p.date)}</div></div></div>`;
    h += `<div style="font-size:26px;font-weight:800;color:#09090b;letter-spacing:-1px;margin-bottom:4px">${title}</div>`;
    h += `<div style="font-size:13px;color:#71717a;margin-bottom:24px">${isInv ? 'Invoice for' : 'Proposal for'} <strong style="color:#800020">${esc(p.client.name)}</strong> · ${isInv ? 'Due' : 'Valid until'} ${fmtDate(p.validUntil)}</div>`;
    h += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px;page-break-inside:avoid;break-inside:avoid"><div style="padding:16px;border:1px solid #e4e4e7;border-radius:8px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;font-weight:700;color:#a1a1aa;margin-bottom:6px">From</div><div style="font-size:13px;font-weight:600">${esc(p.sender.company)}</div><div style="font-size:11px;color:#71717a;margin-top:2px">${buildSenderDetails()}</div>${buildSenderTaxLine()}</div><div style="padding:16px;border:1px solid #e4e4e7;border-radius:8px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;font-weight:700;color:#a1a1aa;margin-bottom:6px">${isInv ? 'Bill To' : 'Client'}</div><div style="font-size:13px;font-weight:600">${esc(p.client.name)}</div><div style="font-size:11px;color:#71717a;margin-top:2px">${buildClientDetails(p.client)}</div></div></div>`;
    if (!isInv) secs.forEach(s => { if (s.type && typeof buildStructuredSectionPdf === 'function') { h += buildStructuredSectionPdf(s, bc); } else { h += `<div style="margin-bottom:24px"><div style="font-size:14px;font-weight:700;margin-bottom:6px;color:#09090b">${esc(s.title)}</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(s.content, p)}</div></div>`; } });
    if (rows.length) { h += `<div style="font-size:14px;font-weight:700;color:#09090b;margin:24px 0 8px">${isInv ? 'Items' : 'Pricing'}</div>`; h += buildPricingHtml(rows, c, t, bc, 'modern'); }
    if (p.paymentTerms) h += `<div style="font-size:14px;font-weight:700;color:#09090b;margin:24px 0 6px">Terms</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(p.paymentTerms, p)}</div>`;
    h += buildBankFooterHtml(bc);
    h += `<div style="height:3px;background:linear-gradient(90deg,${bc},${bc}88);margin:28px -20px -20px;border-radius:0"></div>`;
    return h;
}

function buildFormalTpl(p, c, bc, t, rows, secs, logo, title, num, isInv) {
    const ver = p.version > 1 ? ' v' + p.version : '';
    let h = `<div style="text-align:center;margin-bottom:28px;padding-bottom:20px;border-bottom:2px double #d4d4d8">${logo ? `<div style="margin-bottom:10px">${logo}</div>` : ''}<div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;font-weight:700;color:${bc}">${esc(p.sender.company)}</div><div style="font-size:11px;color:#71717a;margin-top:4px">${buildSenderDetails()}</div>${buildSenderTaxLine()}</div>`;
    h += `<div style="text-align:center;margin-bottom:24px"><div style="font-size:24px;font-weight:800;color:#09090b;letter-spacing:-.5px">${title}${ver}</div><div style="font-size:12px;color:#a1a1aa;margin-top:4px">${num} · ${fmtDate(p.date)}</div></div>`;
    h += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:28px;padding:14px;background:#fafafa;border-radius:6px;font-size:12px;page-break-inside:avoid;break-inside:avoid"><div><strong style="color:${bc}">${isInv ? 'Bill To' : 'Client'}</strong><br>${esc(p.client.name)}<br><span style="color:#71717a">${buildClientDetails(p.client)}</span></div><div><strong style="color:${bc}">Contact</strong><br>${esc(p.client.contact)}<br><span style="color:#71717a">${esc(p.client.phone)}${p.client.address ? '<br>' + esc(p.client.address) : ''}</span></div><div><strong style="color:${bc}">${isInv ? 'Due Date' : 'Valid Until'}</strong><br>${fmtDate(p.validUntil)}<br><span style="color:${bc};font-weight:700;font-family:'JetBrains Mono',monospace">${fmtCur(t.grand, c)}</span></div></div>`;
    if (!isInv) secs.forEach(s => { if (s.type && typeof buildStructuredSectionPdf === 'function') { h += buildStructuredSectionPdf(s, bc); } else { h += `<div style="margin-bottom:24px"><div style="font-size:13px;font-weight:700;color:#09090b;text-align:center;padding:6px 0;border-bottom:1px solid #e4e4e7;margin-bottom:8px">${esc(s.title)}</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(s.content, p)}</div></div>`; } });
    if (rows.length) { h += `<div style="font-size:13px;font-weight:700;color:#09090b;text-align:center;padding:6px 0;border-bottom:1px solid #e4e4e7;margin:24px 0 8px">${isInv ? 'Items' : 'Pricing'}</div>`; h += buildPricingHtml(rows, c, t, bc, 'modern'); }
    if (p.paymentTerms) h += `<div style="font-size:13px;font-weight:700;color:#09090b;text-align:center;padding:6px 0;border-bottom:1px solid #e4e4e7;margin:24px 0 8px">Payment Terms</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(p.paymentTerms, p)}</div>`;
    h += buildBankFooterHtml(bc);
    h += `<div style="text-align:center;margin-top:28px;padding-top:16px;border-top:2px double #d4d4d8;font-size:11px;color:#a1a1aa">${esc(p.sender.company)} · ${esc(CONFIG?.email)} · ${esc(CONFIG?.phone)}</div>`;
    return h;
}

function buildCleanTpl(p, c, bc, t, rows, secs, logo, title, num, isInv) {
    let h = logo;
    h += `<div style="margin-bottom:32px"><div style="font-size:11px;font-weight:600;color:${bc};text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">${isInv ? 'Invoice' : 'Proposal'}</div><div style="font-size:26px;font-weight:800;color:#09090b;letter-spacing:-1px">${title}</div></div>`;
    h += `<div style="display:flex;gap:40px;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid #f4f4f5;page-break-inside:avoid;break-inside:avoid">`;
    h += `<div><div style="font-size:11px;color:#a1a1aa;margin-bottom:2px">From</div><div style="font-size:13px;font-weight:600">${esc(p.sender.company)}</div><div style="font-size:11px;color:#71717a;margin-top:2px">${buildSenderDetails()}</div>${buildSenderTaxLine()}</div>`;
    h += `<div><div style="font-size:11px;color:#a1a1aa;margin-bottom:2px">${isInv ? 'Bill To' : 'Client'}</div><div style="font-size:13px;font-weight:600">${esc(p.client.name)}</div><div style="font-size:11px;color:#71717a;margin-top:2px">${buildClientDetails(p.client)}</div></div>`;
    h += `<div style="margin-left:auto;text-align:right"><div style="font-size:11px;color:#a1a1aa">${num}${p.version > 1 ? ' · v' + p.version : ''}</div><div style="font-size:11px;color:#a1a1aa;margin-top:2px">${fmtDate(p.date)}</div><div style="font-size:11px;color:#a1a1aa;margin-top:2px">${isInv ? 'Due' : 'Valid'}: ${fmtDate(p.validUntil)}</div><div style="font-size:18px;font-weight:800;color:${bc};font-family:'JetBrains Mono',monospace;margin-top:6px">${fmtCur(t.grand, c)}</div></div></div>`;
    if (!isInv) secs.forEach(s => { if (s.type && typeof buildStructuredSectionPdf === 'function') { h += buildStructuredSectionPdf(s, bc); } else { h += `<div style="margin-bottom:24px"><div style="font-size:13px;font-weight:700;color:#09090b;margin-bottom:6px">${esc(s.title)}</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(s.content, p)}</div></div>`; } });
    if (rows.length) { h += `<div style="font-size:13px;font-weight:700;color:#09090b;margin:24px 0 8px">Pricing</div>`; h += buildPricingHtml(rows, c, t, bc, 'modern'); }
    if (p.paymentTerms) h += `<div style="font-size:13px;font-weight:700;color:#09090b;margin:24px 0 6px">Terms</div><div style="color:#52525b;font-size:13px;line-height:1.7">${editorJsToHtml(p.paymentTerms, p)}</div>`;
    h += buildBankFooterHtml(bc);
    return h;
}

function buildNordTpl(p, c, bc, t, rows, secs, logo, title, num, isInv) {
    let h = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:28px">${logo}<div style="display:flex;gap:20px;font-size:11px;color:#a1a1aa"><span>${num}</span><span>${fmtDate(p.date)}</span>${p.version > 1 ? `<span>v${p.version}</span>` : ''}</div></div>`;
    h += `<div style="font-size:32px;font-weight:900;color:#09090b;letter-spacing:-1.5px;line-height:1.1;margin-bottom:6px">${title}</div>`;
    h += `<div style="font-size:14px;color:#71717a;margin-bottom:32px">${isInv ? 'Invoice for' : 'A proposal for'} ${esc(p.client.name)}</div>`;
    h += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:28px;margin-bottom:36px;page-break-inside:avoid;break-inside:avoid">`;
    h += `<div style="padding:18px;background:#f8fafc;border-radius:10px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#94a3b8;font-weight:700;margin-bottom:8px">Our details</div><div style="font-size:13px;font-weight:600;color:#0f172a">${esc(p.sender.company)}</div><div style="font-size:12px;color:#64748b;margin-top:4px;line-height:1.6">${buildSenderDetails()}</div>${buildSenderTaxLine()}</div>`;
    h += `<div style="padding:18px;background:#f8fafc;border-radius:10px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#94a3b8;font-weight:700;margin-bottom:8px">${isInv ? 'Billed to' : 'Your details'}</div><div style="font-size:13px;font-weight:600;color:#0f172a">${esc(p.client.name)}</div><div style="font-size:12px;color:#64748b;margin-top:4px;line-height:1.6">${buildClientDetails(p.client)}</div></div></div>`;
    h += `<div style="display:flex;gap:16px;margin-bottom:32px;page-break-inside:avoid;break-inside:avoid"><div style="flex:1;padding:14px;background:${bc}0A;border-radius:8px;border:1px solid ${bc}22"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:${bc};font-weight:700">Total</div><div style="font-size:22px;font-weight:800;color:${bc};font-family:'JetBrains Mono',monospace;margin-top:2px">${fmtCur(t.grand, c)}</div></div><div style="flex:1;padding:14px;background:#f8fafc;border-radius:8px"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:#94a3b8;font-weight:700">${isInv ? 'Due Date' : 'Valid Until'}</div><div style="font-size:15px;font-weight:600;color:#0f172a;margin-top:4px">${fmtDate(p.validUntil)}</div></div></div>`;
    if (!isInv) secs.forEach(s => { if (s.type && typeof buildStructuredSectionPdf === 'function') { h += buildStructuredSectionPdf(s, bc); } else { h += `<div style="margin-bottom:24px"><div style="font-size:14px;font-weight:700;color:#0f172a;margin-bottom:8px">${esc(s.title)}</div><div style="color:#475569;font-size:13px;line-height:1.8">${editorJsToHtml(s.content, p)}</div></div>`; } });
    if (rows.length) { h += `<div style="font-size:14px;font-weight:700;color:#0f172a;margin:24px 0 8px">Pricing</div>`; h += buildPricingHtml(rows, c, t, bc, 'modern'); }
    if (p.paymentTerms) h += `<div style="font-size:14px;font-weight:700;color:#0f172a;margin:24px 0 6px">Payment Terms</div><div style="color:#475569;font-size:13px;line-height:1.8">${editorJsToHtml(p.paymentTerms, p)}</div>`;
    h += buildBankFooterHtml(bc);
    return h;
}

function buildAmericanTpl(p, c, bc, t, rows, secs, logo, title, num, isInv) {
    const ver = p.version > 1 ? ` (Rev ${p.version})` : '';
    let h = `<div style="display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:20px;border-bottom:3px solid ${bc};margin-bottom:24px">${logo}<div style="text-align:right"><div style="font-size:24px;font-weight:800;color:${bc};letter-spacing:-.5px">${isInv ? 'INVOICE' : 'PROPOSAL'}</div><div style="font-size:12px;color:#71717a;margin-top:4px">${num}${ver}</div></div></div>`;
    h += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:32px;margin-bottom:28px;page-break-inside:avoid;break-inside:avoid"><div><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:#a1a1aa;margin-bottom:6px">From</div><div style="font-size:14px;font-weight:700;color:#800020">${esc(p.sender.company)}</div><div style="font-size:12px;color:#71717a;margin-top:4px;line-height:1.6">${buildSenderDetails()}</div>${buildSenderTaxLine()}</div><div><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:#a1a1aa;margin-bottom:6px">${isInv ? 'Bill To' : 'Prepared For'}</div><div style="font-size:14px;font-weight:700;color:#800020">${esc(p.client.name)}</div><div style="font-size:12px;color:#71717a;margin-top:4px;line-height:1.6">${buildClientDetails(p.client)}</div></div></div>`;
    h += `<div style="display:flex;gap:16px;margin-bottom:28px;padding:14px 18px;background:#f9fafb;border-radius:6px;border:1px solid #e5e7eb;page-break-inside:avoid;break-inside:avoid"><div style="flex:1"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:#6b7280;font-weight:600">Date</div><div style="font-size:13px;font-weight:600;margin-top:2px">${fmtDate(p.date)}</div></div><div style="flex:1"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:#6b7280;font-weight:600">${isInv ? 'Due Date' : 'Valid Through'}</div><div style="font-size:13px;font-weight:600;margin-top:2px">${fmtDate(p.validUntil)}</div></div><div style="flex:1;text-align:right"><div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:#6b7280;font-weight:600">${isInv ? 'Amount Due' : 'Total'}</div><div style="font-size:18px;font-weight:800;color:${bc};font-family:'JetBrains Mono',monospace;margin-top:2px">${fmtCur(t.grand, c)}</div></div></div>`;
    h += `<div style="font-size:20px;font-weight:800;color:#800020;margin-bottom:20px;letter-spacing:-.5px">${title}</div>`;
    if (!isInv) secs.forEach(s => { if (s.type && typeof buildStructuredSectionPdf === 'function') { h += buildStructuredSectionPdf(s, bc); } else { h += `<div style="margin-bottom:24px"><div style="font-size:13px;font-weight:700;color:#800020;margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">${esc(s.title)}</div><div style="color:#4b5563;font-size:13px;line-height:1.7">${editorJsToHtml(s.content, p)}</div></div>`; } });
    if (rows.length) { h += `<div style="font-size:13px;font-weight:700;color:#800020;margin:24px 0 8px;text-transform:uppercase;letter-spacing:.5px">${isInv ? 'Line Items' : 'Scope & Pricing'}</div>`; h += buildPricingHtml(rows, c, t, bc, 'modern'); }
    if (p.paymentTerms) h += `<div style="font-size:13px;font-weight:700;color:#800020;margin:24px 0 6px;text-transform:uppercase;letter-spacing:.5px">Terms & Conditions</div><div style="color:#4b5563;font-size:12px;line-height:1.7">${editorJsToHtml(p.paymentTerms, p)}</div>`;
    h += buildBankFooterHtml(bc);
    h += `<div style="margin-top:32px;padding-top:16px;border-top:1px solid #e5e7eb;font-size:11px;color:#9ca3af;text-align:center">${esc(p.sender.company)} · ${esc(CONFIG?.email || '')} · ${esc(CONFIG?.phone || '')}</div>`;
    return h;
}
